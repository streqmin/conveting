{% extends "base.html" %}
{% load static %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/hospital/hospitals.css' %}">
{% endblock %}
{% block content %}
  <h2 class="section-title">ë‚´ ì£¼ë³€ ë™ë¬¼ë³‘ì›</h2>
  {# 1) ì»¤ìŠ¤í…€ ë¡œë” HTML (ì´ˆê¸° ìˆ¨ê¹€) #}
  <div id="loader" class="main">
    <div class="dog">
      <div class="dog__paws">
        <div class="dog__bl-leg leg">
          <div class="dog__bl-paw paw"></div>
          <div class="dog__bl-top top"></div>
        </div>
        <div class="dog__fl-leg leg">
          <div class="dog__fl-paw paw"></div>
          <div class="dog__fl-top top"></div>
        </div>
        <div class="dog__fr-leg leg">
          <div class="dog__fr-paw paw"></div>
          <div class="dog__fr-top top"></div>
        </div>
      </div>
      <div class="dog__body">
        <div class="dog__tail"></div>
      </div>
      <div class="dog__head">
        <div class="dog__snout">
          <div class="dog__nose"></div>
          <div class="dog__eyes">
            <div class="dog__eye-l"></div>
            <div class="dog__eye-r"></div>
          </div>
        </div>
      </div>
      <div class="dog__head-c">
        <div class="dog__ear-l"></div>
        <div class="dog__ear-r"></div>
      </div>
    </div>
  </div>
  {# 2) ê²°ê³¼ ì»¨í…Œì´ë„ˆ + ì´ˆê¸° í”Œë ˆì´ìŠ¤í™€ë” #}
  <div id="hospitals-list" class="hospital-grid">
    <p id="placeholder-msg">ì£¼ë³€ ë³‘ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
  </div>
  <script>
  const defaultImage = "{% static 'img/default_hospital.png' %}";
  const loader       = document.getElementById("loader");
  const container    = document.getElementById("hospitals-list");
  const placeholder  = document.getElementById("placeholder-msg");

  if (!navigator.geolocation) {
    placeholder.textContent = "ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤";
  } else {
    navigator.geolocation.getCurrentPosition(async pos => {
      // â–¶ ë¡œë” ë³´ì´ê¸°
      loader.style.display = "flex";
      placeholder && placeholder.remove();

      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      try {
        const res  = await fetch("{% url 'nearest_hospitals' %}?lat=" + lat + "&lng=" + lng);
        if (!res.ok) throw new Error(res.statusText);
        const list = await res.json();

        if (!list.length) {
          container.innerHTML = "<p>ì£¼ë³€ì— ë“±ë¡ëœ ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        // â–¶ ê²°ê³¼ ë Œë”ë§
        container.innerHTML = "";
        list.forEach(h => {
          const imgSrc = h.photo || defaultImage;
          const card  = document.createElement("div");
          card.className = "hospital-card";
          card.innerHTML = `
            <div class="card-img-wrap">
              <img src="${imgSrc}" alt="${h.name}" />
            </div>
            <div class="card-body">
              <h3 class="card-title">${h.name}</h3>
              <p class="card-text">${h.address}</p>
              <p class="card-text">ğŸš— ${h.distance} km</p>
              <p class="card-text">ğŸ“ <a href="tel:${h.phone}">${h.phone}</a></p>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        container.innerHTML = "<p>ë³‘ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
      } finally {
        // â–¶ ë¡œë” ìˆ¨ê¸°ê¸°
        loader.style.display = "none";
      }
    }, () => {
      loader.style.display = "none";
      container.innerHTML = "<p>ìœ„ì¹˜ ì‚¬ìš©ì„ í—ˆìš©í•´ì•¼ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>";
    });
  }
  </script>
{% endblock content %}
