<h2>{{ post.title }}</h2>
<p>
    <strong>작성자:</strong> {{ post.user.username }}
</p>
<p>
    <strong>반려견:</strong> {{ post.dog.name }}
</p>
<p>
    <strong>견종:</strong> {{ post.breed }}
</p>
<p>
    <strong>질환:</strong> {{ post.disease.name }}
</p>
<p>
    <strong>질환 부위:</strong> {{ post.get_body_part_display }}
</p>
<p>
    <strong>작성일:</strong> {{ post.created_at|date:"Y-m-d H:i" }}
</p>
{% if post.image %}
    <div>
        <img src="{{ post.image.url }}" style="max-width: 400px;" alt="게시글 이미지">
    </div>
{% endif %}
<hr>
<p>{{ post.content|linebreaks }}</p>
<form id="like-form"
      method="post"
      action="{% url 'post_like_toggle' post.id %}">
    {% csrf_token %}
    <button type="submit">
        {% if has_liked %}
            ♥ 좋아요 취소
        {% else %}
            ♡ 좋아요
        {% endif %}
    </button>
</form>
<p id="like-count">{{ post.likes.count }}명이 좋아합니다.</p>
<p>
    <a href="{% url 'post_list' %}">← 게시글 목록으로 돌아가기</a>
</p>
{# templates/post/post_detail.html #}
<h2>댓글</h2>
{# 댓글 작성 폼 (루트 댓글용) #}
<form method="post" action="{% url 'comment_create' post.id %}">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit">댓글 작성</button>
</form>
<hr>
{# 댓글 목록 #}
{% for comment in post.comments.all %}
    {% if not comment.parent_comment %}
        <div style="margin-bottom: 1em;">
            <strong>{{ comment.user.username }}</strong> | {{ comment.created_at|date:"Y-m-d H:i" }}
            <br>
            {{ comment.content|linebreaks }}
            {# 댓글 좋아요 버튼 #}
            {% if comment.id in liked_comment_ids %}
                <button class="like-btn" data-comment-id="{{ comment.id }}" data-liked="true">
                    ❤️ <span class="like-count">{{ comment.likes.count }}</span>
                </button>
            {% else %}
                <button class="like-btn"
                        data-comment-id="{{ comment.id }}"
                        data-liked="false">
                    🤍 <span class="like-count">{{ comment.likes.count }}</span>
                </button>
            {% endif %}
            {# 대댓글 작성 폼 토글 #}
            <details>
                <summary>답글 달기</summary>
                <form method="post" action="{% url 'comment_create' post.id %}">
                    {% csrf_token %}
                    <textarea name="content" rows="2" placeholder="답글을 입력하세요..."></textarea>
                    <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                    <button type="submit">답글 작성</button>
                </form>
            </details>
            {# 대댓글 목록 #}
            {% for reply in comment.replies.all %}
                <div style="margin-left: 2em;
                            border-left: 1px solid #ccc;
                            padding-left: 1em">
                    <strong>{{ reply.user.username }}</strong> | {{ reply.created_at|date:"Y-m-d H:i" }}
                    <br>
                    {{ reply.content|linebreaks }}
                    {# 대댓글 좋아요 버튼 #}
                    {% if reply.id in liked_comment_ids %}
                        <button class="like-btn" data-comment-id="{{ reply.id }}" data-liked="true">
                            ❤️ <span class="like-count">{{ reply.likes.count }}</span>
                        </button>
                    {% else %}
                        <button class="like-btn" data-comment-id="{{ reply.id }}" data-liked="false">
                            🤍 <span class="like-count">{{ reply.likes.count }}</span>
                        </button>
                    {% endif %}
                    <details>
                        <summary>답글 달기</summary>
                        <form method="post" action="{% url 'comment_create' post.id %}">
                            {% csrf_token %}
                            <textarea name="content" rows="2" placeholder="답글을 입력하세요..."></textarea>
                            <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                            <button type="submit">답글 작성</button>
                        </form>
                    </details>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% empty %}
    <p>아직 댓글이 없습니다.</p>
{% endfor %}
<script>
    document.querySelectorAll(".like-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
            const commentId = this.dataset.commentId;
            const liked = this.dataset.liked === "true";
    
            fetch(`/post/comment/${commentId}/like/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
            })
            .then((res) => res.json())
            .then((data) => {
                // 업데이트된 좋아요 상태 반영
                this.dataset.liked = data.liked;
                this.querySelector(".like-count").textContent = data.like_count;
                this.innerHTML =
                    (data.liked ? "❤️" : "🤍") +
                    ` <span class="like-count">${data.like_count}</span>`;
            });
        });
    });
</script>
