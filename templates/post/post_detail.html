<h2>{{ post.title }}</h2>
<p>
    <strong>ì‘ì„±ì:</strong> {{ post.user.username }}
</p>
<p>
    <strong>ë°˜ë ¤ê²¬:</strong> {{ post.dog.name }}
</p>
<p>
    <strong>ê²¬ì¢…:</strong> {{ post.breed }}
</p>
<p>
    <strong>ì§ˆí™˜:</strong> {{ post.disease.name }}
</p>
<p>
    <strong>ì§ˆí™˜ ë¶€ìœ„:</strong> {{ post.get_body_part_display }}
</p>
<p>
    <strong>ì‘ì„±ì¼:</strong> {{ post.created_at|date:"Y-m-d H:i" }}
</p>
{% if post.image %}
    <div>
        <img src="{{ post.image.url }}" style="max-width: 400px;" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
    </div>
{% endif %}
<hr>
<p>{{ post.content|linebreaks }}</p>
<form id="like-form"
      method="post"
      action="{% url 'post_like_toggle' post.id %}">
    {% csrf_token %}
    <button type="submit">
        {% if has_liked %}
            â™¥ ì¢‹ì•„ìš” ì·¨ì†Œ
        {% else %}
            â™¡ ì¢‹ì•„ìš”
        {% endif %}
    </button>
</form>
<p id="like-count">{{ post.likes.count }}ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤.</p>
<p>
    <a href="{% url 'post_list' %}">â† ê²Œì‹œê¸€ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</p>
{# templates/post/post_detail.html #}
<h2>ëŒ“ê¸€</h2>
{# ëŒ“ê¸€ ì‘ì„± í¼ (ë£¨íŠ¸ ëŒ“ê¸€ìš©) #}
<form method="post" action="{% url 'comment_create' post.id %}">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
</form>
<hr>
{# ëŒ“ê¸€ ëª©ë¡ #}
{% for comment in post.comments.all %}
    {% if not comment.parent_comment %}
        <div style="margin-bottom: 1em;">
            <strong>{{ comment.user.username }}</strong> | {{ comment.created_at|date:"Y-m-d H:i" }}
            <br>
            {{ comment.content|linebreaks }}
            {# ëŒ“ê¸€ ì¢‹ì•„ìš” ë²„íŠ¼ #}
            {% if comment.id in liked_comment_ids %}
                <button class="like-btn" data-comment-id="{{ comment.id }}" data-liked="true">
                    â¤ï¸ <span class="like-count">{{ comment.likes.count }}</span>
                </button>
            {% else %}
                <button class="like-btn"
                        data-comment-id="{{ comment.id }}"
                        data-liked="false">
                    ğŸ¤ <span class="like-count">{{ comment.likes.count }}</span>
                </button>
            {% endif %}
            {# ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ í† ê¸€ #}
            <details>
                <summary>ë‹µê¸€ ë‹¬ê¸°</summary>
                <form method="post" action="{% url 'comment_create' post.id %}">
                    {% csrf_token %}
                    <textarea name="content" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                    <button type="submit">ë‹µê¸€ ì‘ì„±</button>
                </form>
            </details>
            {# ëŒ€ëŒ“ê¸€ ëª©ë¡ #}
            {% for reply in comment.replies.all %}
                <div style="margin-left: 2em;
                            border-left: 1px solid #ccc;
                            padding-left: 1em">
                    <strong>{{ reply.user.username }}</strong> | {{ reply.created_at|date:"Y-m-d H:i" }}
                    <br>
                    {{ reply.content|linebreaks }}
                    {# ëŒ€ëŒ“ê¸€ ì¢‹ì•„ìš” ë²„íŠ¼ #}
                    {% if reply.id in liked_comment_ids %}
                        <button class="like-btn" data-comment-id="{{ reply.id }}" data-liked="true">
                            â¤ï¸ <span class="like-count">{{ reply.likes.count }}</span>
                        </button>
                    {% else %}
                        <button class="like-btn" data-comment-id="{{ reply.id }}" data-liked="false">
                            ğŸ¤ <span class="like-count">{{ reply.likes.count }}</span>
                        </button>
                    {% endif %}
                    <details>
                        <summary>ë‹µê¸€ ë‹¬ê¸°</summary>
                        <form method="post" action="{% url 'comment_create' post.id %}">
                            {% csrf_token %}
                            <textarea name="content" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                            <button type="submit">ë‹µê¸€ ì‘ì„±</button>
                        </form>
                    </details>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% empty %}
    <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}
<script>
    document.querySelectorAll(".like-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
            const commentId = this.dataset.commentId;
            const liked = this.dataset.liked === "true";
    
            fetch(`/post/comment/${commentId}/like/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
            })
            .then((res) => res.json())
            .then((data) => {
                // ì—…ë°ì´íŠ¸ëœ ì¢‹ì•„ìš” ìƒíƒœ ë°˜ì˜
                this.dataset.liked = data.liked;
                this.querySelector(".like-count").textContent = data.like_count;
                this.innerHTML =
                    (data.liked ? "â¤ï¸" : "ğŸ¤") +
                    ` <span class="like-count">${data.like_count}</span>`;
            });
        });
    });
</script>
